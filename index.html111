<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抽签分组神器</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons (Vanilla JS version) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f3f4f6;
        }

        .animate-bounce-short {
            animation: bounce-short 0.5s infinite;
        }

        @keyframes bounce-short {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(0); }
        }

        .winner-pop {
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Rolling animation effect */
        .rolling-text {
            transition: all 0.1s ease;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Icon Handling Fix ---
        // Robust wrapper for Lucide Icons
        const IconWrapper = ({ name, size = 24, className = "" }) => {
            const svgHtml = useMemo(() => {
                if (!window.lucide || !window.lucide.icons || !window.lucide.icons[name]) {
                    return null;
                }
                
                try {
                    const element = window.lucide.createElement(window.lucide.icons[name]);
                    element.setAttribute('width', size);
                    element.setAttribute('height', size);
                    
                    const baseClass = element.getAttribute('class') || '';
                    if (className) {
                        element.setAttribute('class', `${baseClass} ${className}`.trim());
                    }
                    
                    return element.outerHTML;
                } catch (e) {
                    console.error(`Error generating icon ${name}:`, e);
                    return null;
                }
            }, [name, size, className]);

            if (!svgHtml) return null;
            
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} className="inline-flex items-center justify-center" />;
        };

        const createIcon = (name) => (props) => <IconWrapper name={name} {...props} />;

        // Define icons
        const Users = createIcon('Users');
        const Gift = createIcon('Gift');
        const Shuffle = createIcon('Shuffle');
        const Upload = createIcon('Upload');
        const Trash2 = createIcon('Trash2');
        const Download = createIcon('Download');
        const UserPlus = createIcon('UserPlus');
        const Grid = createIcon('Grid');
        const CheckCircle = createIcon('CheckCircle');
        const XCircle = createIcon('XCircle');
        const RotateCcw = createIcon('RotateCcw');
        const FileText = createIcon('FileText');
        const AlertCircle = createIcon('AlertCircle');
        const Sparkles = createIcon('Sparkles');
        const RefreshCw = createIcon('RefreshCw');
        const Eraser = createIcon('Eraser');

        const App = () => {
            const [activeTab, setActiveTab] = useState('input'); // input, lottery, groups
            const [names, setNames] = useState([]);
            const [inputText, setInputText] = useState('');
            
            // Lottery State
            const [currentName, setCurrentName] = useState('准备抽奖');
            const [isRolling, setIsRolling] = useState(false);
            const [winners, setWinners] = useState([]);
            const [allowDuplicates, setAllowDuplicates] = useState(false);
            const intervalRef = useRef(null);

            // Grouping State
            const [groupSize, setGroupSize] = useState(3);
            const [groups, setGroups] = useState([]);

            // --- Derived State for Duplicates ---
            const nameCounts = useMemo(() => {
                const counts = {};
                names.forEach(n => counts[n] = (counts[n] || 0) + 1);
                return counts;
            }, [names]);

            const hasDuplicates = useMemo(() => {
                return Object.values(nameCounts).some(c => c > 1);
            }, [nameCounts]);

            const duplicateCount = useMemo(() => {
                return names.length - Object.keys(nameCounts).length;
            }, [names, nameCounts]);

            // --- Input Handlers ---
            const handleTextChange = (e) => {
                setInputText(e.target.value);
                // Note: We no longer automatically update 'names' on type to support the manual "Update" button workflow
            };

            const manualUpdateNames = () => {
                const list = inputText.split(/[\n,]+/).map(n => n.trim()).filter(n => n !== '');
                setNames(list);
                if (list.length > 0) {
                    alert(`已更新名单！共 ${list.length} 人`);
                } else {
                    alert('请输入姓名后更新');
                }
            };

            const clearInputText = () => {
                if(inputText && confirm('确定要清空输入框的内容吗？这也会清空当前的名单。')) {
                    setInputText('');
                    setNames([]);
                    setWinners([]);
                    setGroups([]);
                }
            };

            const loadMockData = () => {
                const mockNames = [
                    "王小明", "陈怡君", "林志玲", "张学友", "周杰伦", 
                    "蔡依林", "五月天", "刘德华", "梁朝伟", "金城武",
                    "王小明", "陈怡君", "林志豪", "黄雅婷", "李大仁", 
                    "程又青", "谢安真", "温瑞凡", "江直树", "袁湘琴"
                ];
                const text = mockNames.join('\n');
                setInputText(text);
                setNames(mockNames);
                alert('已加载示例数据（包含重复姓名以供测试）！');
            };

            const removeDuplicates = () => {
                const uniqueNames = [...new Set(names)];
                setNames(uniqueNames);
                setInputText(uniqueNames.join('\n'));
                alert(`已移除 ${duplicateCount} 个重复项目！`);
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const text = event.target.result;
                    const list = text.split(/[\r\n,]+/).map(n => n.trim()).filter(n => n !== '');
                    setNames(list);
                    setInputText(list.join('\n'));
                    alert(`CSV 导入成功！共 ${list.length} 人`);
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const clearAll = () => {
                if(confirm('确定要清空所有名单数据吗？')) {
                    setNames([]);
                    setInputText('');
                    setWinners([]);
                    setGroups([]);
                    setCurrentName('准备抽奖');
                }
            };

            // --- Lottery Handlers ---
            const startLottery = () => {
                if (names.length === 0) {
                    alert('请先在“名单管理”输入或导入名单！');
                    setActiveTab('input');
                    return;
                }

                let candidates = names;
                if (!allowDuplicates) {
                    candidates = names.filter(n => !winners.includes(n));
                }

                if (candidates.length === 0) {
                    alert('所有人皆已中奖！请重置中奖名单或允许重复中奖。');
                    return;
                }

                setIsRolling(true);
                
                intervalRef.current = setInterval(() => {
                    const randomIdx = Math.floor(Math.random() * candidates.length);
                    setCurrentName(candidates[randomIdx]);
                }, 80);
            };

            const stopLottery = () => {
                clearInterval(intervalRef.current);
                setIsRolling(false);
                
                let candidates = names;
                if (!allowDuplicates) {
                    candidates = names.filter(n => !winners.includes(n));
                }

                if (candidates.length > 0) {
                    const finalWinnerIndex = Math.floor(Math.random() * candidates.length);
                    const finalWinner = candidates[finalWinnerIndex];
                    setCurrentName(finalWinner);
                    setWinners(prev => [finalWinner, ...prev]);
                }
            };

            const resetWinners = () => {
                if(confirm('确定要清空已中奖名单吗？')) {
                    setWinners([]);
                    setCurrentName('准备抽奖');
                }
            };

            // --- Grouping Handlers ---
            const generateGroups = () => {
                if (names.length === 0) {
                    alert('没有名单可以分组，请先导入名单。');
                    return;
                }
                if (groupSize < 1) {
                    alert('每组人数至少需为 1 人');
                    return;
                }

                let shuffled = [...names];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }

                const newGroups = [];
                for (let i = 0; i < shuffled.length; i += parseInt(groupSize)) {
                    newGroups.push(shuffled.slice(i, i + parseInt(groupSize)));
                }
                setGroups(newGroups);
            };

            const downloadGroupsCSV = () => {
                if (groups.length === 0) {
                    alert('请先产生分组结果！');
                    return;
                }

                // Add BOM for Excel utf-8 compatibility
                let csvContent = "\uFEFF组别,姓名\n";
                
                groups.forEach((group, groupIdx) => {
                    group.forEach(member => {
                        const safeName = member.includes(',') ? `"${member}"` : member;
                        csvContent += `第 ${groupIdx + 1} 组,${safeName}\n`;
                    });
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `分组结果_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- Render Components ---
            const TabButton = ({ id, icon: Icon, label }) => (
                <button
                    onClick={() => setActiveTab(id)}
                    className={`flex items-center justify-center gap-2 px-6 py-4 flex-1 font-bold transition-all duration-200
                        ${activeTab === id 
                            ? 'bg-white text-indigo-600 border-t-4 border-indigo-600 shadow-sm' 
                            : 'bg-gray-100 text-gray-500 hover:bg-gray-200 hover:text-gray-700'
                        }`}
                >
                    <Icon size={20} />
                    {label}
                </button>
            );

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto">
                    <header className="mb-8 text-center">
                        <h1 className="text-3xl md:text-4xl font-extrabold text-indigo-900 flex items-center justify-center gap-3">
                            <Gift className="text-pink-500" size={36} />
                            抽签分组神器
                        </h1>
                        <p className="text-gray-500 mt-2">简单、快速、可视化的活动小助手</p>
                    </header>

                    <div className="bg-white rounded-2xl shadow-xl overflow-hidden min-h-[600px] flex flex-col">
                        <div className="flex border-b border-gray-200 overflow-x-auto">
                            <TabButton id="input" icon={Users} label="1. 名单管理" />
                            <TabButton id="lottery" icon={Gift} label="2. 幸运抽奖" />
                            <TabButton id="groups" icon={Shuffle} label="3. 自动分组" />
                        </div>

                        <div className="p-6 md:p-8 flex-1 bg-gray-50">
                            
                            {/* TAB 1: INPUT */}
                            {activeTab === 'input' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="bg-indigo-50 p-6 rounded-xl border border-indigo-100">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="text-lg font-bold text-indigo-900 flex items-center gap-2">
                                                <UserPlus size={20} />
                                                导入人员名单
                                            </h3>
                                            <button 
                                                onClick={loadMockData}
                                                className="text-sm bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg hover:bg-indigo-200 transition-colors flex items-center gap-1 font-medium"
                                            >
                                                <Sparkles size={16} /> 加载示例数据
                                            </button>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="space-y-3">
                                                <label className="block text-sm font-medium text-gray-700">方法 A: 直接粘贴 (一行一个姓名)</label>
                                                <textarea 
                                                    className="w-full h-48 p-4 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none resize-none bg-white"
                                                    placeholder="王小明&#10;李大华&#10;陈雅婷..."
                                                    value={inputText}
                                                    onChange={handleTextChange}
                                                ></textarea>
                                                
                                                {/* NEW: Method 1 Buttons */}
                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={manualUpdateNames}
                                                        className="flex-1 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2 font-medium transition-colors shadow-sm"
                                                    >
                                                        <RefreshCw size={16} />
                                                        更新名单
                                                    </button>
                                                    <button 
                                                        onClick={clearInputText}
                                                        className="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center justify-center gap-2 font-medium transition-colors"
                                                    >
                                                        <Eraser size={16} />
                                                        清空内容
                                                    </button>
                                                </div>

                                                <div className="flex justify-between items-center text-sm text-gray-500 mt-2">
                                                    <span>目前共 {names.length} 笔数据</span>
                                                </div>
                                            </div>

                                            <div className="space-y-3 flex flex-col">
                                                <label className="block text-sm font-medium text-gray-700">方法 B: 上传 CSV 文件</label>
                                                <div className="border-2 border-dashed border-indigo-200 rounded-lg p-8 flex flex-col items-center justify-center bg-white hover:bg-indigo-50 transition-colors cursor-pointer relative flex-1 min-h-[120px]">
                                                    <Upload className="text-indigo-400 mb-2" size={32} />
                                                    <span className="text-indigo-600 font-medium">点击上传 .csv 文件</span>
                                                    <input 
                                                        type="file" 
                                                        accept=".csv,.txt"
                                                        onChange={handleFileUpload}
                                                        className="absolute inset-0 opacity-0 cursor-pointer"
                                                    />
                                                </div>
                                                <button 
                                                    onClick={clearAll}
                                                    className="w-full py-2 px-4 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 flex items-center justify-center gap-2 font-medium transition-colors mt-2"
                                                >
                                                    <Trash2 size={18} />
                                                    清空所有数据
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Preview Section */}
                                    {names.length > 0 && (
                                        <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                            <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
                                                <h3 className="font-bold text-gray-700 flex items-center gap-2">
                                                    <FileText size={18} /> 名单预览
                                                </h3>
                                                {hasDuplicates && (
                                                    <div className="flex items-center gap-3 bg-orange-50 px-3 py-1.5 rounded-lg border border-orange-100">
                                                        <span className="text-sm text-orange-700 font-medium flex items-center gap-1">
                                                            <AlertCircle size={16} /> 检测到 {duplicateCount} 个重复姓名
                                                        </span>
                                                        <button 
                                                            onClick={removeDuplicates}
                                                            className="text-xs bg-orange-500 text-white px-3 py-1 rounded-full hover:bg-orange-600 transition-colors shadow-sm"
                                                        >
                                                            一键去重
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex flex-wrap gap-2 max-h-48 overflow-y-auto p-2 bg-gray-50 rounded-lg inner-shadow">
                                                {names.map((name, i) => (
                                                    <span 
                                                        key={i} 
                                                        className={`px-3 py-1 rounded-full text-sm flex items-center gap-1 border transition-colors
                                                            ${nameCounts[name] > 1 
                                                                ? 'bg-orange-100 text-orange-800 border-orange-200 font-medium' 
                                                                : 'bg-white text-gray-600 border-gray-200'}`}
                                                    >
                                                        {name}
                                                        {nameCounts[name] > 1 && (
                                                            <span className="w-4 h-4 bg-orange-500 text-white rounded-full text-[10px] flex items-center justify-center" title="重复项目">!</span>
                                                        )}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* TAB 2: LOTTERY */}
                            {activeTab === 'lottery' && (
                                <div className="h-full flex flex-col md:flex-row gap-6">
                                    <div className="flex-1 flex flex-col items-center justify-center bg-white rounded-2xl shadow-sm border border-gray-200 p-8 relative overflow-hidden">
                                        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
                                        
                                        <h2 className="text-gray-400 font-medium mb-6 tracking-widest uppercase text-sm">Winner IS</h2>
                                        
                                        <div className={`text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-br from-indigo-600 to-purple-600 text-center mb-10 min-h-[1.2em] flex items-center justify-center ${!isRolling && currentName !== '准备抽奖' ? 'winner-pop' : ''}`}>
                                            {currentName}
                                        </div>

                                        <div className="flex gap-4">
                                            {!isRolling ? (
                                                <button 
                                                    onClick={startLottery}
                                                    className="px-8 py-3 bg-indigo-600 text-white text-xl font-bold rounded-full hover:bg-indigo-700 shadow-lg hover:shadow-indigo-500/30 transform hover:-translate-y-1 transition-all active:scale-95 flex items-center gap-2"
                                                >
                                                    <Gift size={24} />
                                                    开始抽奖
                                                </button>
                                            ) : (
                                                <button 
                                                    onClick={stopLottery}
                                                    className="px-8 py-3 bg-red-500 text-white text-xl font-bold rounded-full hover:bg-red-600 shadow-lg hover:shadow-red-500/30 transform transition-all active:scale-95 animate-pulse"
                                                >
                                                    停止
                                                </button>
                                            )}
                                        </div>

                                        <div className="mt-8 flex items-center gap-2 text-sm text-gray-500 bg-gray-50 px-4 py-2 rounded-full cursor-pointer hover:bg-gray-100" onClick={() => setAllowDuplicates(!allowDuplicates)}>
                                            {allowDuplicates ? <CheckCircle className="text-green-500" size={16} /> : <XCircle className="text-gray-400" size={16} />}
                                            <span>允许重复中奖</span>
                                        </div>
                                    </div>

                                    <div className="w-full md:w-80 bg-white rounded-2xl shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                                        <div className="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                                            <h3 className="font-bold text-gray-700 flex items-center gap-2">
                                                <Gift size={18} className="text-pink-500"/>
                                                中奖名单 ({winners.length})
                                            </h3>
                                            {winners.length > 0 && (
                                                <button onClick={resetWinners} className="text-xs text-red-500 hover:text-red-700 flex items-center gap-1">
                                                    <RotateCcw size={12} /> 重置
                                                </button>
                                            )}
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-4 space-y-2 max-h-[400px]">
                                            {winners.length === 0 ? (
                                                <div className="text-center text-gray-400 py-10">
                                                    尚未产生幸运儿
                                                </div>
                                            ) : (
                                                winners.map((winner, idx) => (
                                                    <div key={idx} className="flex items-center gap-3 p-3 bg-yellow-50 rounded-lg border border-yellow-100 winner-pop">
                                                        <span className="w-6 h-6 rounded-full bg-yellow-400 text-yellow-900 text-xs font-bold flex items-center justify-center">
                                                            {winners.length - idx}
                                                        </span>
                                                        <span className="font-medium text-gray-800">{winner}</span>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* TAB 3: GROUPS */}
                            {activeTab === 'groups' && (
                                <div className="space-y-6">
                                    <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col md:flex-row items-center gap-6 justify-between">
                                        <div className="flex items-center gap-4">
                                            <div className="flex flex-col">
                                                <label className="text-sm font-bold text-gray-700 mb-1">每组人数设置</label>
                                                <div className="flex items-center gap-2">
                                                    <input 
                                                        type="number" 
                                                        min="1"
                                                        value={groupSize} 
                                                        onChange={(e) => setGroupSize(Math.max(1, parseInt(e.target.value) || 1))}
                                                        className="w-24 p-2 border border-gray-300 rounded-lg text-center font-bold text-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                                                    />
                                                    <span className="text-gray-500">人 / 组</span>
                                                </div>
                                            </div>
                                            <div className="h-10 w-px bg-gray-200 hidden md:block"></div>
                                            <div className="text-sm text-gray-500">
                                                <p>总人数: <span className="font-bold text-gray-800">{names.length}</span></p>
                                                <p>预计组数: <span className="font-bold text-gray-800">{Math.ceil(names.length / groupSize)}</span></p>
                                            </div>
                                        </div>

                                        <div className="flex gap-2 w-full md:w-auto">
                                            <button 
                                                onClick={downloadGroupsCSV}
                                                disabled={groups.length === 0}
                                                className={`px-4 py-3 border border-gray-300 text-gray-700 font-bold rounded-lg flex items-center justify-center gap-2 transition-colors ${groups.length === 0 ? 'opacity-50 cursor-not-allowed bg-gray-50' : 'hover:bg-gray-50 bg-white shadow-sm'}`}
                                            >
                                                <Download size={20} />
                                                下载 CSV
                                            </button>
                                            <button 
                                                onClick={generateGroups}
                                                className="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95 flex-1 md:flex-none"
                                            >
                                                <Shuffle size={20} />
                                                随机自动分组
                                            </button>
                                        </div>
                                    </div>

                                    {groups.length > 0 && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                            {groups.map((group, idx) => (
                                                <div key={idx} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden winner-pop" style={{animationDelay: `${idx * 0.05}s`}}>
                                                    <div className="bg-gray-50 p-3 border-b border-gray-100 flex justify-between items-center">
                                                        <h4 className="font-bold text-gray-700">第 {idx + 1} 组</h4>
                                                        <span className="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">{group.length} 人</span>
                                                    </div>
                                                    <div className="p-4">
                                                        <ul className="space-y-2">
                                                            {group.map((member, mIdx) => (
                                                                <li key={mIdx} className="flex items-center gap-2 text-gray-700">
                                                                    <span className="w-1.5 h-1.5 rounded-full bg-indigo-400"></span>
                                                                    {member}
                                                                </li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {groups.length === 0 && (
                                        <div className="text-center py-20 text-gray-400 flex flex-col items-center">
                                            <Grid size={48} className="mb-4 text-gray-300" />
                                            <p>调整人数设置后，点击“随机自动分组”查看结果</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <footer className="mt-8 text-center text-gray-400 text-sm">
                        <p>&copy; 抽签分组神器 created for efficiency.</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>

